<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课堂随机抽人</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .name-display {
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            border-radius: 8px;
            background-color: #f9f9f9;
            border: 2px dashed #ddd;
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            transition: all 0.3s;
        }
        
        .name-display.highlight {
            background-color: #e8f4fc;
            border-color: #3498db;
            color: #2980b9;
            transform: scale(1.05);
        }
        
        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #startBtn {
            background-color: #2ecc71;
            color: white;
        }
        
        #startBtn:hover {
            background-color: #27ae60;
        }
        
        #stopBtn {
            background-color: #e74c3c;
            color: white;
        }
        
        #stopBtn:hover {
            background-color: #c0392b;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .footer {
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
        }

        .loading {
            display: none;
            margin-top: 20px;
            color: #7f8c8d;
        }

        .error {
            display: none;
            margin-top: 20px;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>课堂随机抽人</h1>
        <div class="name-display" id="nameDisplay">正在加载学生数据...</div>
        <div class="buttons">
            <button id="startBtn" disabled>开始抽人</button>
            <button id="stopBtn" disabled>停止抽人</button>
        </div>
        <div class="loading" id="loading">正在从服务器加载学生数据...</div>
        <div class="error" id="error"></div>
        <div class="footer">随机选择一名学生回答问题</div>
    </div>

    <script>
        // 获取DOM元素
        const nameDisplay = document.getElementById('nameDisplay');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        
        // 定义变量
        let isSelecting = false;
        let selectionInterval;
        let selectedStudent = '';
        let students_true = {};
        let students_false = [];
        
        // 从服务器加载学生数据
        async function loadStudentData() {
            try {
                loading.style.display = 'block';
                const response = await fetch('https://tim-cn.github.io/chou_ren/DATA/students.data');
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                
                const data = await response.text();
                parseStudentData(data);
                
                loading.style.display = 'none';
                startBtn.disabled = false;
                nameDisplay.textContent = "点击开始按钮抽取学生";
                
            } catch (err) {
                console.error('加载学生数据失败:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = `加载数据失败: ${err.message}. 使用默认数据`;
                
                // 使用默认数据作为备选
                students_true = {
                    '曹雨涵': 1,
                    '厉夏': 10,
                    '张三': 5,
                    '李四': 3,
                    '王五': 7,
                    '赵六': 2,
                    '钱七': 4,
                    '孙八': 6
                };
                
                students_false = ['曹雨涵', '厉夏', '张三', '李四', '王五', '赵六', '钱七', '孙八'];
                
                startBtn.disabled = false;
                nameDisplay.textContent = "点击开始按钮抽取学生";
            }
        }
        
        // 解析学生数据
        function parseStudentData(data) {
            try {
                // 使用更健壮的解析方法
                const trueMatch = data.match(/students_true\s*=\s*{([^}]*)}/);
                if (trueMatch && trueMatch[1]) {
                    const trueContent = trueMatch[1];
                    // 分割并清理数据
                    const trueLines = trueContent.split(',')
                        .map(line => line.trim())
                        .filter(line => line);
                    
                    students_true = {};
                    trueLines.forEach(line => {
                        // 支持多种格式: '名字':权重 或 "名字":权重
                        const match = line.match(/['"]([^'"]+)['"]\s*:\s*([\d.]+)/);
                        if (match) {
                            students_true[match[1]] = parseFloat(match[2]);
                        }
                    });
                }
                
                // 解析students_false
                const falseMatch = data.match(/students_false\s*=\s*{([^}]*)}/);
                if (falseMatch && falseMatch[1]) {
                    const falseContent = falseMatch[1];
                    // 分割并清理数据
                    students_false = falseContent.split(',')
                        .map(name => name.trim().replace(/['"]/g, ''))
                        .filter(name => name);
                }
                
                console.log('解析的学生数据:', { students_true, students_false });
                
            } catch (err) {
                console.error('解析学生数据失败:', err);
                throw new Error('数据格式不正确');
            }
        }
        
        // 按权重随机选择学生
        function selectStudentByWeight() {
            // 计算总权重
            const totalWeight = Object.values(students_true).reduce((sum, weight) => sum + weight, 0);
            
            // 生成一个随机数
            const random = Math.random() * totalWeight;
            
            // 根据权重选择学生
            let current = 0;
            for (const [name, weight] of Object.entries(students_true)) {
                current += weight;
                if (random <= current) {
                    return name;
                }
            }
            
            // 如果由于浮点精度问题没有返回，返回最后一个学生
            return Object.keys(students_true).pop();
        }
        
        // 开始选择
        function startSelection() {
            if (Object.keys(students_true).length === 0 || students_false.length === 0) {
                error.style.display = 'block';
                error.textContent = '没有可用的学生数据';
                return;
            }
            
            isSelecting = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            error.style.display = 'none';
            nameDisplay.classList.remove('highlight');
            
            // 先按权重选择实际要抽中的学生
            selectedStudent = selectStudentByWeight();
            console.log('实际抽中学生:', selectedStudent); // 仅用于调试
            
            // 开始快速闪烁显示学生名字
            let index = 0;
            selectionInterval = setInterval(() => {
                nameDisplay.textContent = students_false[index];
                index = (index + 1) % students_false.length;
            }, 100);
        }
        
        // 停止选择
        function stopSelection() {
            isSelecting = false;
            clearInterval(selectionInterval);
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            // 显示实际抽中的学生
            nameDisplay.textContent = selectedStudent;
            nameDisplay.classList.add('highlight');
        }
        
        // 初始化
        function init() {
            // 添加事件监听器
            startBtn.addEventListener('click', startSelection);
            stopBtn.addEventListener('click', stopSelection);
            
            // 加载学生数据
            loadStudentData();
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>
